{% extends "layouts/main.html" %}

{% set pageName="Community prompt library" %}

{% block beforeContent %}
  {{ govukBreadcrumbs({
    items: [
      {
        text: "Home",
        href: "/"
      },
      {
        text: "Prompt library"
      }
    ]
  }) }}
  <a class="govuk-back-link" href="/" onclick="window.history.back(); return false;">Back</a>
{% endblock %}

{% block content %}

<style>
  /* Reduce card header height */
  .govuk-summary-card__title-wrapper {
    padding: 10px 20px;
  }
  
  /* Reduce actions container padding */
  .govuk-summary-card__actions {
    padding: 10px 20px;
  }
  
  /* Remove button margins in card actions */
  .govuk-summary-card__actions .govuk-button {
    margin: 0;
  }
  
  /* Hide default separators */
  .govuk-summary-card__action {
    border-left: none !important;
  }
</style>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">

    <h1 class="govuk-heading-xl">Community prompt library</h1>
    
    <p class="govuk-body-l">Browse and share prompts created by Defra colleagues.</p>

    {% if data['success'] == 'true' %}
      {{ govukNotificationBanner({
        type: "success",
        html: "<p class=\"govuk-notification-banner__heading\">Your prompt has been submitted successfully</p>"
      }) }}
    {% endif %}

    <form class="form" action="/prompt-library" method="get">
      <div class="govuk-grid-row">
        <div class="govuk-grid-column-one-half">
          <div class="govuk-form-group">
            <label class="govuk-label" for="search">
              Search prompts
            </label>
            <input class="govuk-input" id="search" name="search" type="text" placeholder="Search by title, description, or category">
          </div>
        </div>
        <div class="govuk-grid-column-one-quarter">
          <div class="govuk-form-group">
            <label class="govuk-label" for="category">
              Filter by category
            </label>
            <select class="govuk-select" id="category" name="category">
              <option value="">All categories</option>
              <option value="code-review">Code review</option>
              <option value="debugging">Debugging</option>
              <option value="documentation">Documentation</option>
              <option value="testing">Testing</option>
              <option value="refactoring">Refactoring</option>
              <option value="general">General development</option>
            </select>
          </div>
        </div>
        <div class="govuk-grid-column-one-quarter">
          <div class="govuk-form-group">
            <label class="govuk-label" for="search-button" style="visibility: hidden;">Search</label>
            <button class="govuk-button" data-module="govuk-button" id="search-button">Search</button>
          </div>
        </div>
      </div>
    </form>

    <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">

    <div class="govuk-grid-row">
      <div class="govuk-grid-column-full">

        <h2 class="govuk-heading-l">All prompts</h2>

        <div class="govuk-summary-card">
          <div class="govuk-summary-card__title-wrapper">
            <h3 class="govuk-summary-card__title">Code Generator</h3>
            <ul class="govuk-summary-card__actions">
              <li class="govuk-summary-card__action">
                <button class="govuk-button" type="button" onclick="copyPromptToClipboard('prompt1')">Copy prompt</button>
              </li>
              <li class="govuk-summary-card__action">
                <button class="govuk-button govuk-button--secondary" type="button" onclick="upvotePrompt('prompt1', this)">↑ Upvote (23)</button>
              </li>
            </ul>
          </div>
          <div class="govuk-summary-card__content">
            <dl class="govuk-summary-list">
              <div class="govuk-summary-list__row">
                <dt class="govuk-summary-list__key">Category</dt>
                <dd class="govuk-summary-list__value">Code review</dd>
              </div>
              <div class="govuk-summary-list__row">
                <dt class="govuk-summary-list__key">Submitted by</dt>
                <dd class="govuk-summary-list__value">Sarah Chen (sarah.chen@defra.gov.uk)</dd>
              </div>
              <div class="govuk-summary-list__row">
                <dt class="govuk-summary-list__key">Prompt</dt>
                <dd class="govuk-summary-list__value">
                  <div class="govuk-!-padding-3" style="background-color: #f3f2f1; font-family: monospace;">
                    <pre id="prompt1" style="white-space: pre-wrap; word-wrap: break-word; margin: 0;">I have provided you with a Product Requirements document(PRD). Please analyze the features and User Stories and implement as follows:

1. First, outline your understanding of:
   - The specific requirements from this story
   - How this feature integrates with existing functionality
   - Any dependencies or prerequisites

2. Perform a codebase analysis focusing on:
   - Existing patterns and conventions to follow
   - Integration points for the new feature
   - Reusable components or utilities

3. Provide an implementation plan including:
   - Component/file structure
   - Required changes to existing code
   - New components/modules to be created

4. For the implementation:
   - Follow existing code conventions and patterns
   - Maintain consistent naming and structure
   - Add appropriate error handling

5. Verification checklist:
   - List each requirement from the user story
   - Confirm implementation status of each requirement
   - Note any assumptions or decisions made

Constraints:
- Maintain consistency with existing codebase
- Follow the AI rules
- Do not add any unit tests at this time</pre>
                  </div>
                </dd>
              </div>
            </dl>
          </div>
        </div>

        <div class="govuk-summary-card">
          <div class="govuk-summary-card__title-wrapper">
            <h3 class="govuk-summary-card__title">Unit Test Generator</h3>
            <ul class="govuk-summary-card__actions">
              <li class="govuk-summary-card__action">
                <button class="govuk-button" type="button" onclick="copyPromptToClipboard('prompt2')">Copy prompt</button>
              </li>
              <li class="govuk-summary-card__action">
                <button class="govuk-button govuk-button--secondary" type="button" onclick="upvotePrompt('prompt2', this)">↑ Upvote (18)</button>
              </li>
            </ul>
          </div>
          <div class="govuk-summary-card__content">
            <dl class="govuk-summary-list">
              <div class="govuk-summary-list__row">
                <dt class="govuk-summary-list__key">Category</dt>
                <dd class="govuk-summary-list__value">Testing</dd>
              </div>
              <div class="govuk-summary-list__row">
                <dt class="govuk-summary-list__key">Submitted by</dt>
                <dd class="govuk-summary-list__value">James Wilson (james.wilson@defra.gov.uk)</dd>
              </div>
              <div class="govuk-summary-list__row">
                <dt class="govuk-summary-list__key">Prompt</dt>
                <dd class="govuk-summary-list__value">
                  <div class="govuk-!-padding-3" style="background-color: #f3f2f1; font-family: monospace;">
                    <pre id="prompt2" style="white-space: pre-wrap; word-wrap: break-word; margin: 0;"># CONTEXT

I have provided you with a Product Requirements Document (PRD). Please analyze feature [FEATURE_NAME] and its User Stories to create comprehensive Jest tests. Do not work on other features yet.

## ANALYSIS PHASE

Before writing tests, please analyze:
- The specific feature and associated user stories in the PRD
- The relevant source code components and their interactions
- Unit interactions with other components/services
- External dependencies requiring mocks (APIs, services, databases)
- Data models, state management, and user data flows
- Existing test coverage and testing patterns used in the codebase

## IMPLEMENTATION PHASE

### Testing Philosophy:
- Focus on user-visible behavior and outcomes rather than implementation details
- Test both server-rendered content and client-side interactive behaviors
- Verify functionality from a user's perspective (what users see and experience)
- Test component contracts and interfaces, not internal workings
- Mock external dependencies like APIs, but use realistic mock data

### Test Types to Include:
- Functional tests that verify user workflows
- Component rendering tests (snapshot or DOM verification)
- Interactive behavior tests (user actions, form submissions)
- Error handling and edge case tests
- Accessibility tests where applicable

### Test Structure:
- Use Given-When-Then pattern with descriptive comments
- Maintain clarity by using descriptive test names
- Group related tests logically using nested `describe` blocks
- Use setup and teardown hooks consistently (`beforeEach`, `afterEach`)
- Isolate tests to prevent cross-test dependencies

## CONSTRAINTS

- Scope: Modify only the test files, not the source code
- Format: Deliver complete, production-ready test code
- Coverage: Aim for comprehensive coverage of user scenarios rather than 100% code coverage
- Performance: Ensure tests run efficiently and don't cause unnecessary re-renders

## VERIFICATION PHASE

Please provide:
1. A summary of your analysis of the feature
2. The complete test implementation with explanatory comments
3. An execution report for the tests
4. Any issues encountered and their solutions
5. Recommendations for improving testability (if applicable)
</pre>
                  </div>
                </dd>
              </div>
            </dl>
          </div>
        </div>

        <button class="govuk-button govuk-button--secondary" data-module="govuk-button" onclick="toggleAddPrompt()">
          Add your own prompt
        </button>

        <div id="add-prompt-form" style="display: none;" class="govuk-!-margin-top-6">
          <h2 class="govuk-heading-l">Add a new prompt</h2>
          
          <form class="form" action="/prompt-library/add" method="post">
            <div class="govuk-form-group">
              <label class="govuk-label" for="prompt-title">
                Prompt title
              </label>
              <div id="prompt-title-hint" class="govuk-hint">
                Maximum 100 characters
              </div>
              <input class="govuk-input" id="prompt-title" name="prompt-title" type="text" maxlength="100" aria-describedby="prompt-title-hint">
            </div>

            <div class="govuk-form-group">
              <label class="govuk-label" for="prompt-description">
                Description
              </label>
              <div id="prompt-description-hint" class="govuk-hint">
                Maximum 200 characters
              </div>
              <textarea class="govuk-textarea" id="prompt-description" name="prompt-description" rows="3" maxlength="200" aria-describedby="prompt-description-hint"></textarea>
            </div>

            <div class="govuk-form-group">
              <label class="govuk-label" for="prompt-text">
                Your prompt
              </label>
              <div id="prompt-text-hint" class="govuk-hint">
                Maximum 8000 characters
              </div>
              <textarea class="govuk-textarea" id="prompt-text" name="prompt-text" rows="8" maxlength="8000" aria-describedby="prompt-text-hint"></textarea>
            </div>

            <div class="govuk-form-group">
              <label class="govuk-label" for="prompt-category">
                Category
              </label>
              <select class="govuk-select" id="prompt-category" name="prompt-category">
                <option value="code-review">Code review</option>
                <option value="debugging">Debugging</option>
                <option value="documentation">Documentation</option>
                <option value="testing">Testing</option>
                <option value="refactoring">Refactoring</option>
                <option value="general">General development</option>
              </select>
            </div>

            <div class="govuk-form-group">
              <label class="govuk-label" for="submitter-name">
                Your name
              </label>
              <input class="govuk-input" id="submitter-name" name="submitter-name" type="text">
            </div>

            <div class="govuk-form-group">
              <label class="govuk-label" for="submitter-email">
                Your email
              </label>
              <input class="govuk-input" id="submitter-email" name="submitter-email" type="email">
            </div>

            <button class="govuk-button" data-module="govuk-button">Submit prompt</button>
          </form>
        </div>

      </div>
    </div>

  </div>
</div>

<script>
  function toggleAddPrompt() {
    var form = document.getElementById('add-prompt-form');
    if (form.style.display === 'none') {
      form.style.display = 'block';
    } else {
      form.style.display = 'none';
    }
  }

  function copyPromptToClipboard(promptId) {
    const promptElement = document.getElementById(promptId);
    const promptText = promptElement.textContent;
    
    // Use the modern Clipboard API if available
    if (navigator.clipboard && window.isSecureContext) {
      navigator.clipboard.writeText(promptText).then(function() {
        showCopySuccess();
      }).catch(function(err) {
        console.error('Failed to copy text: ', err);
        fallbackCopyToClipboard(promptText);
      });
    } else {
      // Fallback for older browsers
      fallbackCopyToClipboard(promptText);
    }
  }

  function upvotePrompt(promptId, buttonElement) {
    // Extract current vote count
    const currentText = buttonElement.textContent;
    const match = currentText.match(/Upvote \((\d+)\)/);
    const currentVotes = match ? parseInt(match[1]) : 0;
    const newVotes = currentVotes + 1;
    
    // Update button text
    buttonElement.textContent = `↑ Upvote (${newVotes})`;
    
    // Show success notification
    showUpvoteSuccess();
    
    // Disable button temporarily to prevent double-clicking
    buttonElement.disabled = true;
    setTimeout(function() {
      buttonElement.disabled = false;
    }, 1000);
  }

  function fallbackCopyToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
      document.execCommand('copy');
      showCopySuccess();
    } catch (err) {
      console.error('Fallback copy failed: ', err);
    } finally {
      document.body.removeChild(textArea);
    }
  }

  function showCopySuccess() {
    showNotification('Prompt copied to clipboard', 'success');
  }

  function showUpvoteSuccess() {
    showNotification('Thank you for your vote!', 'success');
  }

  function showNotification(message, type) {
    // Remove any existing notifications
    const existingNotifications = document.querySelectorAll('.govuk-notification-banner');
    existingNotifications.forEach(function(notification) {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    });

    // Create a new notification
    const notification = document.createElement('div');
    notification.className = 'govuk-notification-banner';
    notification.setAttribute('role', type === 'success' ? 'alert' : 'region');
    notification.innerHTML = `
      <div class="govuk-notification-banner__header">
        <h2 class="govuk-notification-banner__title" id="govuk-notification-banner-title">
          ${type === 'success' ? 'Success' : 'Information'}
        </h2>
      </div>
      <div class="govuk-notification-banner__content">
        <p class="govuk-notification-banner__heading">
          ${message}
        </p>
      </div>
    `;
    
    // Insert at the top of the main content
    const mainContent = document.querySelector('.govuk-grid-row');
    mainContent.insertBefore(notification, mainContent.firstChild);
    
    // Remove the notification after 3 seconds
    setTimeout(function() {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 3000);
  }
</script>

{% endblock %}